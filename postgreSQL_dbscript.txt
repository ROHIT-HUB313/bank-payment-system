---------------------------------09-01-2026((ROHIT))------------------------------------------------------------------
PostgreSQL 817@R
CREATE ROLE bank_admin WITH LOGIN PASSWORD 'Admin@123' CREATEDB;
CREATE ROLE bank_app WITH LOGIN PASSWORD 'App@SecurePass';
GRANT bank_app TO bank_admin;
CREATE DATABASE bank_user_db OWNER bank_admin;
CREATE DATABASE bank_account_db OWNER bank_admin;
CREATE DATABASE bank_transaction_db OWNER bank_admin;

CREATE TABLE users (
    id BIGSERIAL PRIMARY KEY,
    username VARCHAR(255) NOT NULL UNIQUE,
    password VARCHAR(255) NOT NULL,
    email VARCHAR(255) NOT NULL UNIQUE,
    phone_number VARCHAR(255) NOT NULL UNIQUE,
    role VARCHAR(50) NOT NULL, -- 'USER' or 'ADMIN'
    kyc_verified BOOLEAN DEFAULT FALSE,
    address TEXT NOT NULL,
    created_on TIMESTAMP NOT NULL,
    updated_by VARCHAR(255) NOT NULL,
    updated_on TIMESTAMP NOT NULL
);
GRANT CONNECT ON DATABASE bank_user_db TO bank_app;
GRANT USAGE ON SCHEMA public TO bank_app;
GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO bank_app;
GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA public TO bank_app;

REVOKE ALL PRIVILEGES ON ALL TABLES IN SCHEMA public FROM bank_app;
REVOKE ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public FROM bank_app;

GRANT CONNECT ON DATABASE bank_user_db TO bank_app;
GRANT USAGE ON SCHEMA public TO bank_app;
GRANT SELECT, INSERT, UPDATE ON users TO bank_app;
GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA public TO bank_app;


ALTER DEFAULT PRIVILEGES IN SCHEMA public
GRANT SELECT, INSERT, UPDATE ON TABLES TO bank_app;
ALTER DEFAULT PRIVILEGES IN SCHEMA public
GRANT USAGE, SELECT ON SEQUENCES TO bank_app;



CREATE TABLE branch (
    id BIGSERIAL PRIMARY KEY,
    branch_code VARCHAR(50) NOT NULL UNIQUE,
    ifsc_code VARCHAR(50) NOT NULL,
    address TEXT NOT NULL
);
CREATE TABLE bank_accounts (
    bank_id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL,
    account_number VARCHAR(50) NOT NULL UNIQUE,
    account_type VARCHAR(20) NOT NULL, -- 'SAVINGS', 'CURRENT', etc.
    ifsc_code VARCHAR(50) NOT NULL,
    bank_address TEXT NOT NULL,
    account_status VARCHAR(20) NOT NULL, -- 'ACTIVE', 'BLOCKED'
    current_balance DECIMAL(19, 2) NOT NULL DEFAULT 0.00,
    currency VARCHAR(10) NOT NULL,
    created_by VARCHAR(255) NOT NULL,
    created_on TIMESTAMP NOT NULL,
    updated_by VARCHAR(255) NOT NULL,
    updated_on TIMESTAMP NOT NULL,
    version BIGINT -- For Optimistic Locking
);
GRANT CONNECT ON DATABASE bank_account_db TO bank_app;
GRANT USAGE ON SCHEMA public TO bank_app;
GRANT SELECT, INSERT, UPDATE ON bank_accounts TO bank_app;
GRANT SELECT, INSERT, UPDATE ON branch TO bank_app;
GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA public TO bank_app;


ALTER DEFAULT PRIVILEGES IN SCHEMA public
GRANT SELECT, INSERT, UPDATE ON TABLES TO bank_app;
ALTER DEFAULT PRIVILEGES IN SCHEMA public
GRANT USAGE, SELECT ON SEQUENCES TO bank_app;



CREATE TABLE transactions (
    id BIGSERIAL PRIMARY KEY,
    utr VARCHAR(255) NOT NULL,
    account_number VARCHAR(50) NOT NULL,
    amount DECIMAL(19, 2) NOT NULL,
    transaction_type VARCHAR(20) NOT NULL, -- 'CREDIT', 'DEBIT'
    status VARCHAR(20) NOT NULL, -- 'SUCCESS', 'FAILED'
    idempotency_key VARCHAR(255) NOT NULL,
    opening_balance DECIMAL(19, 2),
    closing_balance DECIMAL(19, 2),
    timestamp TIMESTAMP NOT NULL,
    CONSTRAINT unique_transaction UNIQUE (idempotency_key, account_number, transaction_type)
);
GRANT CONNECT ON DATABASE bank_transaction_db TO bank_app;
GRANT USAGE ON SCHEMA public TO bank_app;
GRANT SELECT, INSERT ON transactions TO bank_app;
GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA public TO bank_app;


ALTER DEFAULT PRIVILEGES IN SCHEMA public
GRANT SELECT, INSERT ON TABLES TO bank_app;
ALTER DEFAULT PRIVILEGES IN SCHEMA public
GRANT USAGE, SELECT ON SEQUENCES TO bank_app;

----------------------------------------------------------------------------------------------------------------------------